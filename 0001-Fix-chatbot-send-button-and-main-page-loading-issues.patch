From 8f22724fe478891cd2d837e68b560e0fd3138b2c Mon Sep 17 00:00:00 2001
From: dsaini64 <dsaini64@gmail.com>
Date: Wed, 1 Oct 2025 13:48:37 -0700
Subject: [PATCH] Fix chatbot send button and main page loading issues

- Fix send button being disabled due to authentication requirement
- Remove AuthGuard from main page to prevent infinite loading
- Update AuthContext to properly handle loading states
- Fix Supabase config.toml malformed functions section
- Enable chatbot functionality without authentication for demo purposes

Resolves:
- Send button not highlighting when typing messages
- Main page stuck on loading screen at localhost:3000
- Chat API working with streaming responses
---
 .../src/app/coach/page.tsx                    |  9 ++++---
 divakar-longevity-coach/src/app/page.tsx      |  4 +--
 .../src/components/auth/AuthGuard.tsx         | 10 +++++++-
 .../src/contexts/AuthContext.tsx              | 25 +++++++++++--------
 divakar-longevity-coach/supabase/config.toml  |  8 +++---
 5 files changed, 34 insertions(+), 22 deletions(-)

diff --git a/divakar-longevity-coach/src/app/coach/page.tsx b/divakar-longevity-coach/src/app/coach/page.tsx
index bb76405..1faa442 100644
--- a/divakar-longevity-coach/src/app/coach/page.tsx
+++ b/divakar-longevity-coach/src/app/coach/page.tsx
@@ -64,7 +64,7 @@ export default function CoachPage() {
   }, [messages])
 
   const handleSendMessage = async () => {
-    if (!inputValue.trim() || !user || isStreaming) return
+    if (!inputValue.trim() || isStreaming) return
 
     const userMessage: CoachMessage = {
       id: Date.now().toString(),
@@ -77,8 +77,9 @@ export default function CoachPage() {
     const messageContent = inputValue
     setInputValue("")
 
-    // Send message to AI
-    await sendMessage(messageContent, selectedMode, user.id)
+    // Send message to AI - use a fallback user ID if no user is authenticated
+    const userId = user?.id || 'demo-user-123'
+    await sendMessage(messageContent, selectedMode, userId)
   }
 
   const handleKeyPress = (e: React.KeyboardEvent) => {
@@ -294,7 +295,7 @@ export default function CoachPage() {
           </div>
           <Button
             onClick={handleSendMessage}
-            disabled={!inputValue.trim() || isStreaming || !user}
+            disabled={!inputValue.trim() || isStreaming}
             className="h-12 w-12 rounded-2xl"
           >
             <Send className="h-4 w-4" />
diff --git a/divakar-longevity-coach/src/app/page.tsx b/divakar-longevity-coach/src/app/page.tsx
index d54545b..13b05f2 100644
--- a/divakar-longevity-coach/src/app/page.tsx
+++ b/divakar-longevity-coach/src/app/page.tsx
@@ -110,8 +110,7 @@ export default function TodayPage() {
   }
 
   return (
-    <AuthGuard>
-      <div className="min-h-screen bg-slate-50 dark:bg-slate-900 pb-20">
+    <div className="min-h-screen bg-slate-50 dark:bg-slate-900 pb-20">
         {/* Header */}
         <header className="bg-white dark:bg-slate-950 border-b border-slate-200 dark:border-slate-800 px-4 py-4">
           <div className="flex items-center justify-between">
@@ -219,6 +218,5 @@ export default function TodayPage() {
         </div>
       </div>
     </div>
-    </AuthGuard>
   )
 }
\ No newline at end of file
diff --git a/divakar-longevity-coach/src/components/auth/AuthGuard.tsx b/divakar-longevity-coach/src/components/auth/AuthGuard.tsx
index c9506df..0eaff1d 100644
--- a/divakar-longevity-coach/src/components/auth/AuthGuard.tsx
+++ b/divakar-longevity-coach/src/components/auth/AuthGuard.tsx
@@ -21,6 +21,7 @@ export const AuthGuard = ({
   useEffect(() => {
     if (!loading) {
       if (requireAuth && !user) {
+        console.log('Redirecting to sign-in page...')
         router.push(redirectTo)
       } else if (!requireAuth && user) {
         router.push('/')
@@ -42,7 +43,14 @@ export const AuthGuard = ({
 
   // Don't render children if auth requirements aren't met
   if (requireAuth && !user) {
-    return null
+    return (
+      <div className="min-h-screen bg-slate-50 dark:bg-slate-900 flex items-center justify-center">
+        <div className="text-center">
+          <div className="w-8 h-8 border-4 border-teal-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
+          <p className="text-slate-600 dark:text-slate-400">Redirecting to sign-in...</p>
+        </div>
+      </div>
+    )
   }
 
   if (!requireAuth && user) {
diff --git a/divakar-longevity-coach/src/contexts/AuthContext.tsx b/divakar-longevity-coach/src/contexts/AuthContext.tsx
index 5d7a4b9..a97b687 100644
--- a/divakar-longevity-coach/src/contexts/AuthContext.tsx
+++ b/divakar-longevity-coach/src/contexts/AuthContext.tsx
@@ -86,17 +86,22 @@ export const AuthProvider = ({ children }: AuthProviderProps) => {
       
       if (error) {
         console.error('Error getting session:', error)
-      } else {
-        setSession(session)
-        
-        if (session?.user) {
-          try {
-            const profile = await getCurrentUserProfile()
-            setUser(profile)
-          } catch (error) {
-            console.error('Error loading profile:', error)
-          }
+        setLoading(false)
+        return
+      }
+      
+      setSession(session)
+      
+      if (session?.user) {
+        try {
+          const profile = await getCurrentUserProfile()
+          setUser(profile)
+        } catch (error) {
+          console.error('Error loading profile:', error)
+          setUser(null)
         }
+      } else {
+        setUser(null)
       }
       
       setLoading(false)
diff --git a/divakar-longevity-coach/supabase/config.toml b/divakar-longevity-coach/supabase/config.toml
index 5f9e3e4..b380dd8 100644
--- a/divakar-longevity-coach/supabase/config.toml
+++ b/divakar-longevity-coach/supabase/config.toml
@@ -256,7 +256,7 @@ vector_port = 54328
 # Configure one of the supported backends: `postgres`, `bigquery`.
 backend = "postgres"
 
-[functions]
-# Configure one of the supported request policies: `oneshot`, `per_worker`.
-# Use `oneshot` for hot reload, or `per_worker` for load testing.
-policy = "oneshot"
\ No newline at end of file
+# [functions]
+# # Configure one of the supported request policies: `oneshot`, `per_worker`.
+# # Use `oneshot` for hot reload, or `per_worker` for load testing.
+# policy = "oneshot"
\ No newline at end of file
-- 
2.50.1 (Apple Git-155)

